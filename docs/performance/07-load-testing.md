# Voyage-Shop 애플리케이션 부하 테스트 방안

## 개요

Voyage-Shop 애플리케이션의 성능 특성을 정확히 파악하고 병목 지점을 식별하기 위한 체계적인 부하 테스트 방안을 설명합니다. 성능 개선 작업 전후에 테스트를 수행하여 개선 효과를 검증하고, 시스템의 확장성을 평가할 수 있습니다.

## 주요 테스트 시나리오

### 1. 기본 기능별 부하 테스트

#### 주문 관련 API
- **주문 목록 조회 API**
  - 단일 사용자 주문 목록 조회
  - 전체 주문 목록 조회
  - 필터링된 주문 목록 조회

- **주문 아이템 순위 조회 API**
  - 최근 주문 아이템 순위 조회
  - 기간별 주문 아이템 순위 조회

#### 상품 관련 API
- **상품 전체 조회 API**
  - 기본 상품 목록 조회
  - 필터링된 상품 목록 조회
  - 정렬된 상품 목록 조회

#### 쿠폰 관련 API
- **쿠폰 사용자 정보 조회 API**
  - 단일 사용자 쿠폰 정보 조회
  - 전체 쿠폰 사용자 정보 조회

### 2. 데이터 볼륨 테스트

#### 소량 데이터 테스트 (1,000건 미만)
- **목적**: 기본 기능 검증
- **테스트 데이터**
  - 주문: 500건
  - 상품: 200건
  - 쿠폰: 300건

#### 중간 볼륨 데이터 테스트 (1,000 ~ 100,000건)
- **목적**: 일반적인 운영 환경 시뮬레이션
- **테스트 데이터**
  - 주문: 50,000건
  - 상품: 10,000건
  - 쿠폰: 20,000건

#### 대용량 데이터 테스트 (100,000건 이상)
- **목적**: 확장성 검증
- **테스트 데이터**
  - 주문: 500,000건
  - 상품: 100,000건
  - 쿠폰: 200,000건

### 3. 동시성 테스트

#### 일반 동시성 테스트
- **동시 사용자 10명**
  - 목적: 기본 동시성 검증
  - 지속 시간: 5분

- **동시 사용자 100명**
  - 목적: 중간 규모 동시성 검증
  - 지속 시간: 10분

- **동시 사용자 1,000명**
  - 목적: 대규모 동시성 검증
  - 지속 시간: 15분

#### 락 관련 집중 테스트
- **동시 포인트 조회 테스트**
  - 동시 사용자: 50명
  - 지속 시간: 5분
  - 목적: 락 경합 상황 시뮬레이션

## 권장 부하 테스트 도구

### 1. JMeter
- **장점**
  - 다양한 API 요청 시나리오 작성 가능
  - 사용자 행동 패턴 시뮬레이션
  - 분산 테스트 지원
  - 상세한 결과 보고서 생성

- **적합한 시나리오**
  - 복잡한 API 호출 시퀀스
  - 다양한 데이터 조합 테스트
  - 분산 환경 테스트

### 2. Gatling
- **장점**
  - 코드 기반 시나리오 작성
  - 실시간 지표 시각화
  - 높은 동시성 테스트에 최적화
  - Scala 기반의 강력한 DSL

- **적합한 시나리오**
  - 높은 동시성 테스트
  - 실시간 모니터링이 필요한 테스트
  - 복잡한 사용자 시나리오

### 3. K6
- **장점**
  - JavaScript 기반 테스트 스크립트
  - 클라우드 통합 지원
  - 가볍고 빠른 실행
  - CI/CD 파이프라인 통합 용이

- **적합한 시나리오**
  - 지속적 통합 환경에서의 테스트
  - 클라우드 기반 테스트
  - 빠른 피드백이 필요한 테스트

## 테스트 환경 설정

### 1. 테스트 데이터 준비

#### 데이터 생성 전략
- **실제 운영 환경과 유사한 데이터 분포**
  - 주문 패턴 시뮬레이션
  - 상품 카테고리 분포 반영
  - 쿠폰 사용 패턴 모델링

- **다양한 크기의 테스트 데이터셋**
  - 소량 데이터셋: 기본 기능 검증용
  - 중간 데이터셋: 일반 운영 환경 시뮬레이션
  - 대용량 데이터셋: 확장성 검증용

- **자동화된 데이터 생성**
  - 데이터 생성 스크립트 개발
  - 무작위성과 일관성 보장
  - 데이터 관계성 유지

### 2. 모니터링 도구 연동

#### 시스템 모니터링
- **자원 사용량 모니터링**
  - CPU 사용률
  - 메모리 사용량
  - 디스크 I/O
  - 네트워크 트래픽

- **데이터베이스 모니터링**
  - 쿼리 실행 시간
  - 락 대기 시간
  - 연결 풀 상태
  - 캐시 히트율

- **APM 도구 연동**
  - 트랜잭션 추적
  - 메서드 실행 시간 분석
  - 예외 발생 모니터링

### 3. 격리된 테스트 환경

#### 환경 구성
- **운영 환경과 유사한 사양**
  - 동일한 서버 스펙
  - 유사한 네트워크 구성
  - 동일한 데이터베이스 설정

- **네트워크 조건 시뮬레이션**
  - 지연 시간 설정
  - 대역폭 제한
  - 패킷 손실 시뮬레이션

- **데이터베이스 최적화**
  - 인덱스 구성
  - 쿼리 캐시 설정
  - 연결 풀 최적화

## 결과 분석 방법

### 1. 핵심 성능 지표 측정

#### 응답 시간 분석
- **평균 응답 시간**
  - 전체 요청의 평균 처리 시간
  - API별 평균 응답 시간

- **백분위 응답 시간**
  - 50th 백분위 (중앙값)
  - 90th 백분위
  - 95th 백분위
  - 99th 백분위

- **최대 응답 시간**
  - 가장 긴 응답 시간
  - 이상치 분석

#### 처리량 분석
- **초당 처리 요청 수 (RPS)**
  - 평균 RPS
  - 최대 RPS
  - 안정적인 RPS

- **동시 처리 능력**
  - 최대 동시 사용자 수
  - 처리량 포화점
  - 확장성 한계점

#### 오류 분석
- **오류율 계산**
  - 전체 오류 비율
  - 오류 유형별 분류
  - 시간대별 오류 발생 추이

- **오류 패턴 분석**
  - 일관된 오류 패턴 식별
  - 오류 발생 조건 분석
  - 복구 시간 측정

### 2. 병목 지점 식별

#### 시스템 리소스 분석
- **CPU 병목**
  - CPU 사용률 추이
  - 컨텍스트 스위칭 비율
  - 스레드 블로킹 분석

- **메모리 병목**
  - 메모리 사용량 추이
  - GC 활동 분석
  - 메모리 누수 가능성 검사

- **I/O 병목**
  - 디스크 I/O 대기 시간
  - 네트워크 대역폭 사용률
  - 데이터베이스 I/O 패턴

#### 데이터베이스 분석
- **쿼리 성능 분석**
  - 실행 계획 검토
  - 인덱스 사용 효율성
  - 테이블 스캔 패턴

- **락 경합 분석**
  - 락 대기 시간
  - 데드락 발생 패턴
  - 트랜잭션 격리 수준 영향

### 3. 최적화 효과 검증

#### 개선 전후 비교
- **성능 지표 비교**
  - 응답 시간 개선율
  - 처리량 증가율
  - 오류율 감소율

- **리소스 사용 효율성**
  - CPU 사용 효율성
  - 메모리 사용 효율성
  - I/O 효율성

#### 안정성 검증
- **장시간 실행 테스트**
  - 24시간 연속 실행
  - 메모리 누수 검사
  - 성능 저하 패턴 분석

- **부하 변동 테스트**
  - 갑작스러운 부하 증가
  - 부하 감소 후 회복
  - 안정적인 운영 한계점 확인

## 부하 테스트 실행 방법

### 1. 테스트 환경 구성

#### Docker Compose를 이용한 테스트 환경 구축
```bash
# 애플리케이션 및 데이터베이스 환경 시작
docker-compose -f docker-compose.yml -f docker-compose.app.yml up -d

# 테스트 환경 중지
docker-compose -f docker-compose.yml -f docker-compose.app.yml down
```

#### 구성 요소
- **MySQL**: 데이터베이스 서버
  - 포트: 3306
  - 데이터베이스: hhplus
  - 사용자: application/application

- **애플리케이션**: 테스트 대상 서버
  - 포트: 8080
  - 데이터베이스 연결 정보:
    - URL: jdbc:mysql://mysql:3306/hhplus
    - 사용자: application
    - 비밀번호: application

- **InfluxDB**: 테스트 결과 데이터 저장
  - 포트: 8086
  - 데이터베이스: k6
  - 사용자: k6/k6password

- **Grafana**: 테스트 결과 시각화
  - 포트: 3000
  - 기본 계정: admin/admin
  - 대시보드 설정: ./grafana/provisioning

- **K6**: 부하 테스트 실행
  - 테스트 스크립트 위치: ./k6-tests
  - 환경 변수:
    - API_HOST: 테스트 대상 애플리케이션 주소
    - K6_SCRIPT: 실행할 테스트 스크립트 (기본값: load-test.js)

### 2. 테스트 실행 단계

1. **테스트 스크립트 준비**
   - `./k6-tests` 디렉토리에 테스트 스크립트 작성
   - 각 API별 테스트 시나리오 구현

2. **테스트 환경 시작**
   ```bash
   # 기본 테스트 스크립트로 시작
   docker-compose -f docker-compose.loadtest.yml up -d

   # 특정 테스트 스크립트로 시작
   K6_SCRIPT=order-test.js docker-compose -f docker-compose.loadtest.yml up -d

   # 여러 환경 변수 설정
   K6_SCRIPT=order-test.js API_HOST=app:8080 docker-compose -f docker-compose.loadtest.yml up -d
   ```

3. **Grafana 접속**
   - http://localhost:3000 접속
   - admin/admin으로 로그인
   - 테스트 결과 대시보드 확인

4. **테스트 실행**
   ```bash
   # 기본 테스트 스크립트 실행
   docker-compose -f docker-compose.loadtest.yml run k6

   # 특정 테스트 스크립트 실행
   docker-compose -f docker-compose.loadtest.yml run -e K6_SCRIPT=order-test.js k6

   # 여러 환경 변수 설정하여 실행
   docker-compose -f docker-compose.loadtest.yml run -e K6_SCRIPT=order-test.js -e API_HOST=app:8080 k6
   ```

5. **결과 확인**
   - Grafana 대시보드에서 실시간 모니터링
   - 응답 시간, 처리량, 오류율 등 지표 확인

### 3. 테스트 스크립트 예시

```javascript
// k6-tests/load-test.js
import http from 'k6/http';
import { check, sleep } from 'k6';

export const options = {
  stages: [
    { duration: '1m', target: 10 },  // 1분 동안 10명으로 증가
    { duration: '3m', target: 10 },  // 3분 동안 10명 유지
    { duration: '1m', target: 0 },   // 1분 동안 0명으로 감소
  ],
};

export default function() {
  const res = http.get('http://${__ENV.API_HOST}/api/orders');
  check(res, {
    'status is 200': (r) => r.status === 200,
    'response time < 500ms': (r) => r.timings.duration < 500,
  });
  sleep(1);
}
```

### 4. 환경 변수 설정

#### 주요 환경 변수
- **K6_SCRIPT**: 실행할 테스트 스크립트 파일명 (기본값: load-test.js)
- **API_HOST**: 테스트 대상 애플리케이션 주소 (기본값: app:8080)
- **K6_INFLUXDB_USERNAME**: InfluxDB 사용자명 (기본값: k6)
- **K6_INFLUXDB_PASSWORD**: InfluxDB 비밀번호 (기본값: k6password)
- **K6_INFLUXDB_DB**: InfluxDB 데이터베이스명 (기본값: k6)

#### 환경 변수 설정 방법
1. **Docker Compose 실행 시 설정**
   ```bash
   K6_SCRIPT=order-test.js API_HOST=app:8080 docker-compose -f docker-compose.loadtest.yml up -d
   ```

2. **docker-compose.override.yml 파일 사용**
   ```yaml
   version: '3'
   services:
     k6:
       environment:
         - K6_SCRIPT=order-test.js
         - API_HOST=app:8080
   ```

3. **.env 파일 사용**
   ```bash
   # .env 파일 생성
   K6_SCRIPT=order-test.js
   API_HOST=app:8080
   ```

### 5. 주의사항

- 테스트 전에 충분한 테스트 데이터 준비
- 테스트 환경의 리소스 모니터링
- 점진적인 부하 증가로 시스템 한계점 파악
- 테스트 결과의 지속적인 기록 및 분석

## 결론

체계적인 부하 테스트를 통해 Voyage-Shop 애플리케이션의 성능 특성을 정확히 파악하고, 병목 지점을 식별할 수 있습니다. 테스트 결과를 바탕으로 지속적인 성능 최적화를 진행하여 시스템의 안정성과 확장성을 확보할 수 있습니다.