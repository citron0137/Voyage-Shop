# 서버 부하 분석

## 개요
이 문서는 Voyage-Shop 시스템의 서버 부하를 분석하고 병목 지점을 식별하기 위해 작성되었습니다.

## 목차
1. 서버 부하 분석 목적
2. 부하 테스트 방법론
3. 주요 병목 지점 분석
4. 성능 개선 방안
5. 결론 및 추천 사항

## 서버 부하 분석 목적
Voyage-Shop 시스템의 서버 부하 분석을 수행하는 주요 목적은 다음과 같습니다:

1. **시스템 안정성 확보**  
   트래픽 증가에도 서비스가 안정적으로 운영될 수 있는 시스템 구조를 검증하고 개선합니다. 특히 동시 접속 사용자가 증가할 때 발생할 수 있는 시스템 불안정성을 사전에 파악합니다.

2. **병목 지점 식별**  
   현재 시스템에서 성능 저하를 일으키는 주요 원인을 파악합니다. 비관적 락(Pessimistic Lock) 구현, 복잡한 데이터베이스 쿼리, 비효율적인 동시성 처리 등 시스템 성능에 영향을 미치는 요소들을 식별합니다.

3. **사용자 경험 최적화**  
   쇼핑몰 서비스에서 중요한 상품 조회, 장바구니, 결제 과정의 응답 시간을 개선하여 사용자 이탈을 방지합니다. 특히 결제 과정에서의 지연은 직접적인, 주문 포기로 이어질 수 있어 특별한 관심이 필요합니다.

4. **리소스 효율성 향상**  
   서버 자원과 데이터베이스 리소스를 최적으로 활용하여 불필요한 비용 발생을 방지합니다. 현재 구현된 비관적 락과 같은 메커니즘이 리소스 활용에 미치는 영향을 분석합니다.

5. **확장성 준비**  
   향후 트래픽 증가에 대비하여 시스템의 수평적/수직적 확장 방향을 결정하기 위한 데이터를 확보합니다. 어떤 컴포넌트가 확장성의 제약 요소가 되는지 파악합니다.

6. **특수 상황 대비**  
   플래시 세일, 프로모션 이벤트, 쿠폰 발급과 같은 트래픽 폭증 상황에서도 안정적으로 서비스할 수 있는 시스템을 구축합니다. 이러한 상황을 시뮬레이션하여 시스템의 한계를 파악합니다.

7. **동시성 제어 개선**  
   현재 비관적 락 기반의 동시성 제어 메커니즘을 검증하고 낙관적 락(Optimistic Lock)이나 분산 락(Distributed Lock) 등 더 효율적인 방법으로 개선할 방안을 모색합니다.

## 부하 테스트 방법론
Voyage-Shop 시스템의 부하 테스트는 다음과 같은 방법론을 기반으로 수행됩니다:

### 1. 테스트 도구 및 환경

- **부하 테스트 도구**: k6 (Grafana k6)
  - JavaScript 기반의 모던한 CLI 부하 테스트 도구
  - 간단한 설치 및 직관적인 명령줄 인터페이스
  - 코드 기반 스크립팅으로 다양한 시나리오 구현 가능
  - 확장 모듈을 통한 다양한 프로토콜 지원
  - Grafana와의 원활한 통합으로 실시간 모니터링 가능
- **관측 도구**: Grafana/OpenTelemetry-LGTM 스택 활용
  - **Loki**: 로그 수집 및 분석
  - **Grafana**: 메트릭 및 로그 시각화 대시보드
  - **Tempo**: 분산 트레이싱을 통한 요청 흐름 추적
  - **Mimir**: 대규모 메트릭 데이터 저장 및 분석
- **OpenTelemetry**: 표준화된 방식으로 메트릭, 트레이스, 로그 데이터 수집
- **테스트 환경**: 실제 운영 환경과 유사한 환경을 구축하여 테스트 결과의 신뢰성 확보

### 2. 테스트 시나리오 구성

- **기본 부하 테스트**: 일반 사용량 패턴을 기반으로 사용자 행동 시뮬레이션
  - **인기 상품 목록 조회** (높은 읽기 부하 예상)
  - 일반 상품 목록 및 상세 조회 (읽기 중심)
  - 포인트 조회 및 충전 (쓰기 작업)
  - 쿠폰 목록 조회 및 발급 (읽기/쓰기 혼합)
  - 주문 생성 및 결제 (트랜잭션 처리)

- **스파이크 테스트**: 갑작스런 트래픽 증가 상황 시뮬레이션
  - **인기 상품 페이지 동시 접속 증가** (특정 이벤트 시)
  - 플래시 세일 시작 시 특정 상품 동시 접근
  - 한정 수량 쿠폰 발급 시 동시 요청
  - 인기 상품 재고 변경 시 동시성 제어 검증

- **지속성 테스트**: 장시간 중간 부하 상태에서의 시스템 안정성 검증
  - 24시간 이상 일정 수준의 부하 유지
  - 메모리 누수, 커넥션 풀 고갈 등 장기 운영 시 발생할 수 있는 이슈 검증

### 3. k6 테스트 스크립트 예시

k6 테스트 스크립트는 다음 파일들로 분리하여 작성되었습니다:

- **[voyage-shop-load-test.js](../../scripts/k6/voyage-shop-load-test.js)**: 일반 API 부하 테스트
- **[userpoint-load-test.js](../../scripts/k6/userpoint-load-test.js)**: 포인트 충전/사용 동시성 테스트
- **[product-stock-load-test.js](../../scripts/k6/product-stock-load-test.js)**: 상품 재고 증감 동시성 테스트

#### 스크립트 주요 내용

주요 테스트 스크립트의 특징:

1. **일반 부하 테스트 (voyage-shop-load-test.js)**:
   - 인기 상품 순위 조회 API에 집중된 테스트
   - 상품 목록, 상품 상세, 포인트 잔액, 쿠폰 이벤트 등 다양한 API 호출
   - 자연스러운 사용자 흐름 시뮬레이션을 위한 랜덤 대기 시간

2. **포인트 동시성 테스트 (userpoint-load-test.js)**:
   - 동일 사용자에 대한 동시 포인트 충전/사용 요청 테스트
   - 비관적 락 동작 확인을 위한 배치 요청
   - 트랜잭션 히스토리 조회 기능 테스트

3. **상품 재고 동시성 테스트 (product-stock-load-test.js)**:
   - 인기 상품에 대한 재고 증감 동시 요청 테스트
   - 다수의 사용자가 동시에 재고를 감소시키는 상황 시뮬레이션
   - 재고 부족 상황의 적절한 오류 처리 검증

#### 실행 방법

```bash
# 일반 부하 테스트 실행
k6 run scripts/k6/voyage-shop-load-test.js

# 포인트 동시성 테스트 실행
k6 run scripts/k6/userpoint-load-test.js

# 상품 재고 동시성 테스트 실행
k6 run scripts/k6/product-stock-load-test.js

# Grafana 대시보드로 결과 출력 (설정 필요)
k6 run --out influxdb=http://localhost:8086/k6 scripts/k6/voyage-shop-load-test.js
```

### 4. 핵심 측정 지표

- **처리량(Throughput)**: 초당 처리 요청 수(TPS)
- **응답 시간(Response Time)**: 평균, 50/90/95/99 백분위 응답 시간
- **오류율(Error Rate)**: 전체 요청 대비 실패한 요청의 비율
- **시스템 리소스 사용률**:
  - CPU 사용률
  - 메모리 사용량
  - 디스크 I/O
  - 네트워크 대역폭
- **데이터베이스 성능**:
  - 쿼리 실행 시간
  - 락 경합 상황
  - 커넥션 풀 상태
  - 트랜잭션 처리량

### 5. 테스트 단계별 접근

- **기초 테스트**: 단일 사용자, 단일 요청 시 응답 시간 및 자원 사용량 측정
- **확장 테스트**: 점진적 사용자 증가에 따른 시스템 변화 관찰
- **한계 테스트**: 시스템이 오류를 발생시키기 시작하는 임계점 파악
- **분석 및 최적화**: 측정 데이터 기반으로 병목 지점 식별 및 개선
- **재검증**: 개선 후 재테스트를 통한 효과 검증

### 6. 특별 관심 영역

- **인기 상품 조회 API**: 읽기 중심 부하가 집중되는 주요 지점 (`/api/v1/order-item-rank`)
- **비관적 락 적용 영역**: 포인트 충전/사용, 상품 재고 변경, 쿠폰 발급 등
- **복잡한 트랜잭션 처리**: 주문 생성 및 결제 과정
- **트래픽 집중 구간**: 상품 순위 및 상세 페이지, 인기 쿠폰 관련 API
- **배치 작업과 실시간 요청 간 간섭**: 대량 데이터 처리와 실시간 요청 처리 간 성능 영향

## 주요 병목 지점 분석

### 비관적 락 관련 이슈
<!-- 여기에 비관적 락으로 인한 성능 이슈 분석을 작성하세요 -->

### 동시성 접근 핫스팟
<!-- 여기에 동시 접근이 많은 리소스에 대한 분석을 작성하세요 -->

### 데이터베이스 쿼리 성능
<!-- 여기에 데이터베이스 쿼리 성능에 대한 분석을 작성하세요 -->

### API 응답 시간
<!-- 여기에 API 응답 시간에 대한 분석을 작성하세요 -->

## 성능 개선 방안

### 단기 개선안
<!-- 여기에 단기 개선 방안을 작성하세요 -->

### 중장기 개선안
<!-- 여기에 중장기 개선 방안을 작성하세요 -->

## 결론 및 추천 사항
<!-- 여기에 결론 및 추천 사항을 작성하세요 --> 