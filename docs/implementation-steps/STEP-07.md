# 7단계: JPA 리포지토리 구현 및 통합 테스트

## 작업 개요

이 브랜치(`feat/jpa-repository-implementation`)에서는 도메인 모델과 데이터베이스를 연결하는 **JPA 리포지토리** 구현과 **통합 테스트**를 추가했습니다. 또한 데이터베이스 마이그레이션을 위한 **Flyway** 설정 및 SQL 파일을 구성했습니다.

---

## 주요 작업 내용

### 데이터베이스 스키마 관리 (Flyway)

- Flyway 데이터베이스 마이그레이션 설정 
- 사용자 테이블 생성 SQL 추가
- 제품 테이블 생성 SQL 추가
- 쿠폰 사용자 테이블 및 통합 테스트 추가
- 쿠폰 이벤트 테이블 및 통합 테스트 추가
- 주문 및 결제 테이블 생성 SQL 추가

### JPA 리포지토리 구현

- JPA 리포지토리 구현체 추가 및 폴더 구조 정리
- 상품 조회 시 **동시성 제어**를 위한 락 기능 추가
- 유저 포인트 JPA 레포지토리 구현
- 사용자 포인트 관련 코드 구현

### 통합 테스트 추가

- 사용자 등록 통합 테스트 추가 및 데이터 소스 설정
- 사용자 포인트 흐름 통합 테스트 추가
- 포인트 충전에 대한 **동시성 테스트** 코드 추가
- 상품 서비스 통합 테스트 추가 및 수정
- ProductFacade 통합 테스트 추가
- 주문 파사드 통합 테스트 구현

### 문서화 및 테스트 규약

- README 및 문서 업데이트, 테스트 관련 문서 추가
- 테스트 컨벤션 문서 업데이트 및 구조 개선
- 통합 테스트 관련 가이드라인 추가
- 테스트 메서드 네이밍 규칙 업데이트
- 자세한 내용은 [테스트 컨벤션 문서](../conventions/test-conventions.md) 참조

---

## 커밋 히스토리

### 테스트 컨벤션 정의
- `fdc8557` **테스트 컨벤션 정의** (2025.04.17): 테스트 구조와 네이밍 규칙, 어플리케이션/도메인 서비스 테스트 방법 가이드
- `dbd092c` **테스트 가이드라인** (2025.04.18): 통합 테스트 수행 권장 사항, 비즈니스 시나리오 중심 테스트 범위 지침
- `a8a18fe` **네이밍 규칙 정의** (2025.04.18): 테스트 메서드는 영어로 작성하고 @DisplayName으로 한글 제목 지정, camelCase 스타일 채택


### 공통/인프라
- `b965513` **Flyway 설정** (2025.04.18): 데이터베이스 마이그레이션 환경 구성 및 초기 사용자 테이블 생성 SQL 추가
- `c1faba9` **기본 문서 추가** (2025.04.17): README 업데이트, 프로젝트 구조 및 패키징 문서 작성, 불필요한 파일 제거


### 리포지터리 인터페이스 구현 
- `5f4dbe5` **JPA 리포지토리 구현** (2025.04.15): 도메인별 리포지토리 인터페이스 구현 및 프로젝트 폴더 구조 정리

### 사용자 관련
- `b965514` **사용자 테이블 생성** (2025.04.18): 사용자 및 사용자 포인트 테이블 스키마 SQL 추가
- `feeb6a1` **사용자 등록 테스트** (2025.04.18): Testcontainers를 활용한 MySQL 컨테이너 설정 및 사용자 등록 통합 테스트 구현

### 상품 관련
- `0c1aa67` **제품 테이블 생성** (2025.04.18): 제품 정보(ID, 이름, 가격, 재고, 생성일, 수정일) 테이블 스키마 정의
- `aea4ca7` **비관적 락 적용** (2025.04.18): ProductRepository에 findByIdWithLock 메서드 추가, 재고 업데이트와 조회 시 락 활용
- `f566338` **상품 서비스 테스트** (2025.04.18): 상품 CRUD 기능 통합 테스트 구현
- `539f083` **임포트 오류 수정** (2025.04.18): 상품 서비스 테스트의 ProductQuery 클래스 임포트 누락 수정
- `a950747` **파사드 테스트** (2025.04.18): 테스트 컨벤션을 준수한 ProductFacade 통합 테스트 추가
- `203082d` **테스트 수정** (2025.04.18): 상품 서비스 테스트 케이스 보완 및 오류 수정

### 포인트 관련
- `48519f7` **포인트 레포지토리 구현** (2025.04.18): 사용자 포인트 정보 관리를 위한 JPA 리포지토리 구현체 추가
- `d11a194` **포인트 서비스 구현** (2025.04.18): 포인트 적립, 사용, 조회 등 핵심 비즈니스 로직 구현
- `244aff7` **포인트 흐름 테스트** (2025.04.18): 사용자 생성, 포인트 충전, 조회, 여러 번 충전 시 누적 금액 검증
- `a2b2a98` **동시성 테스트** (2025.04.18): 다중 스레드에서 동시에 포인트 충전 시 발생하는 문제 검증

### 쿠폰 관련
- `9274e58` **쿠폰 사용자 테이블 추가** (2025.04.18): 쿠폰 사용자 정보를 저장하는 coupon_users 테이블 생성 및 발급/사용/조회 테스트
- `aec705f` **쿠폰 이벤트 테이블 추가** (2025.04.18): 쿠폰 이벤트 정보와 발급 가능 수량을 관리하는 coupon_event 테이블 구현

### 주문/결제 관련
- `d022660` **주문/결제 테이블 생성** (2025.04.18): 주문, 주문 항목, 주문 할인, 결제 테이블 스키마 정의 및 주문 파사드 통합 테스트 구현

---

## 주요 기술적 결정

### 1. **Flyway를 사용한 데이터베이스 마이그레이션**
   - 버전 관리 및 팀 협업 효율화를 위해 **Flyway**를 도입
   - **SQL 파일 기반**의 마이그레이션으로 직관적인 관리

### 2. **테스트 컨벤션 개선**
   - **영어 메서드명 + 한글 DisplayName** 형식 표준화
   - 통합 테스트 구조화 및 패턴 정립
   - 자세한 내용은 [테스트 컨벤션 문서](../conventions/test-conventions.md) 참조

### 3. **비관적 락(Pessimistic Lock) 구현**
   - 동시성 제어가 필요한 리소스에 **비관적 락** 적용
   - **`@Lock(LockModeType.PESSIMISTIC_WRITE)`** 어노테이션 활용
   - 포인트 충전, 쿠폰 재고 감소 등의 **동시성 테스트**에서 발생하는 실패를 해결하기 위해 도입
   - 특히 동시에 여러 요청이 몰릴 수 있는 리소스에 대한 테스트가 일관되게 통과할 수 있도록 구현
   - 이는 **임시적인 방편**으로, 추후 **분산 락**이나 **낙관적 락** 등 더 효율적인 방식으로 개선 예정
   - 성능 테스트 후 실제 서비스 부하를 고려한 최적의 동시성 제어 전략 적용 계획


---

## 다음 단계

1. 동시성 관련 이슈들 더 찾아서 수정하기
2. 성능의 문제가 발생할 수 있는 부분 파악하고 미리 대처하기