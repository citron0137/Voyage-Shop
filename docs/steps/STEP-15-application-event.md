# STEP 15: Application Event

## 개요
이 문서에서는 실시간 주문정보를 이벤트 기반으로 데이터 플랫폼에 전송하는 기능을 구현하기 위한 고민을 작성했습니다.


## 해당 문서의 주요 용어 정리

**도메인 경계에 대한 용어**

| 용어            | 핵심 정의                | 주요 특징               |
| ------------- | -------------------- | ------------------- |
| **도메인**       | 비즈니스 문제 영역           | 조직과 시장의 언어로 설명됨     |
| **바운디드 컨텍스트** | 도메인 모델이 일관되게 작동하는 경계 | 서비스나 팀의 책임 단위와 매핑   |
| **도메인 모델**    | 도메인 규칙을 코드로 나타낸 구조   | 객체지향 기반의 설계 요소로 구성됨 |

**레이어 분리에 대한 용어**
| 레이어                          | 주요 책임                      | 구성 요소 예시                                                      | 외부와의 관계                        |
| ---------------------------- | -------------------------- | ------------------------------------------------------------- | ------------------------------ |
| **컨트롤러 (Controller)**        | 사용자 요청 수신 및 응답 반환          | REST Controller, GraphQL Resolver                             | 외부 요청 (HTTP, CLI 등)을 수신        |
| **어플리케이션 (Application)**     | 유스케이스 실행 및 도메인 조합, 트랜잭션 관리 | Application Service, UseCase                                  | 컨트롤러 ↔ 도메인 연결                  |
| **도메인 (Domain)**             | 비즈니스 규칙의 핵심 로직 정의          | Entity, Value Object, Aggregate, Domain Service, Domain Event | 순수한 비즈니스 로직, 외부에 의존 없음         |
| **인프라스트럭처 (Infrastructure)** | 외부 시스템과의 연동 구현             | Repository 구현체, 메시지 큐, 외부 API, DB Adapter                     | 외부 시스템과 연결 (DB, 메시지, 외부 API 등) |

위와 같은 용어 정리가 해당 문서에서 틈틈히 등장할 예정입니다.

## 고민 과정

### **어플리케이션 레이어는 개발 생산성 향상을 위해 꼭 필요하다고 생각합니다.**

어플리케이션 레이어는 복잡한 비즈니스 요구사항을 유스케이스 단위로 구성하여 명확하게 구현할 수 있도록 해주며, 이는 개발 생산성과 유지보수 효율성을 크게 향상시킵니다.

이 레이어는 도메인 모델을 직접 다루기보다는 이를 orchestration(조합)하여 하나의 유스케이스 흐름으로 만들어줍니다. 즉, 도메인의 복잡한 규칙들을 실행 가능한 형태로 묶고, 필요한 트랜잭션 경계를 정의하며, 외부 시스템 호출이나 이벤트 발행 같은 기술적 처리를 함께 다룹니다.

개발자는 이 레이어를 중심으로 기능 구현에 집중할 수 있기 때문에, 도메인 내부 구조에 대한 깊은 이해 없이도 전체적인 비즈니스 흐름을 빠르게 구성할 수 있습니다. 이는 특히 다음과 같은 상황에서 생산성에 기여합니다:

협업 및 역할 분담 시: 도메인 모델과 유스케이스 구현을 명확히 분리할 수 있어 팀원 간 역할을 분할하기 수월합니다. 예를 들어, 한 명은 도메인 규칙을 설계하고 다른 한 명은 유스케이스와 외부 연동을 구현할 수 있습니다.

* 변경 대응: 어플리케이션 레이어는 트랜잭션, 외부 시스템 연동, 이벤트 발행 등을 포괄하므로, 요구사항 변경 시 도메인 로직을 변경하지 않고도 흐름을 조정할 수 있습니다.

* 테스트 용이성: 도메인과 인프라가 분리된 구조 덕분에, 어플리케이션 레이어의 유스케이스는 모킹을 통해 독립적으로 테스트할 수 있습니다.

* 비즈니스 가시성 확보: 유스케이스 중심의 구조는 도메인 모델보다 직관적인 흐름을 제공하므로, 비개발자와의 협업 및 문서화에 유리합니다.

결론적으로, 어플리케이션 레이어는 단순한 계층 이상의 의미를 가지며, 비즈니스 로직의 실행 단위를 중심으로 구현을 구조화하고, 기술적 요소를 적절히 위임하며, 도메인의 순수성과 유연성을 보호하는 핵심 역할을 수행합니다. 이로 인해 전체적인 개발 속도와 품질이 모두 향상될 수 있다고 판단했습니다.

물론 어플리케이션 레이어가 마냥 좋기만 한 것은 아니라는 것은 저도 깊게 생각하고 있습니다.
이에 대해서는 해당 문서 가장 아래 부록에 "어플리케이션 레이어 사용시 주의할 점"을 참고해주시면 좋겠습니다.


### **이벤트를 구현하면서 왜 이런 이야기를 하는거야?**

위와 같은 구조에서는 도메인 레이어 이벤트만 사용하게 되는 경우 아래와 같은 제약 상황이 발생하기 때문입니다.

| 제약사항                            | 설명                                                                                                                                      |
| ------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| **기술적 책임 분리의 어려움**              | 도메인 이벤트만으로 외부 시스템 연동까지 처리하려고 하면, 도메인 레이어가 기술 인프라(예: 메시지 큐, 외부 API 등)와 직접 엮이게 됩니다. 이는 도메인의 순수성을 훼손하며 테스트와 재사용성을 저해합니다.                   |
| **바운디드 컨텍스트 간 통합의 유연성 부족**      | 도메인 이벤트는 주로 같은 컨텍스트 내부에서 의미를 갖습니다. 다른 바운디드 컨텍스트에 이벤트를 전달하거나 연계하는 데에는 적절한 계층(어플리케이션)이 필요합니다. 이를 무시하면 컨텍스트 간 경계가 흐려질 수 있습니다.              |
| **트랜잭션 경계와 이벤트 발행 타이밍 제어의 어려움** | 도메인 이벤트는 주로 트랜잭션 내에서 발생합니다. 이 이벤트를 기반으로 외부 시스템에 메시지를 보낼 경우, 커밋 이전에 발행되거나 실패할 위험이 있습니다. 이는 **Exactly-once** 보장이 필요한 상황에서 문제가 됩니다.        |
| **비동기 처리 전략 구현의 제약**            | 도메인 이벤트만으로는 이벤트 발행 → 핸들링 → 외부 연동까지의 책임이 너무 무겁고, 메시지 큐/이벤트 버스를 통한 비동기 확장이나 복수의 핸들러 적용이 어려워집니다.                                           |
| **테스트 및 디버깅 복잡성 증가**            | 도메인 이벤트에 메시지 전송, 알림 발행 등의 부수효과(side effect)를 직접 묶게 되면, 유닛 테스트 시 mocking 범위가 넓어지고 디버깅이 어려워집니다. 반면 어플리케이션 이벤트는 외부 I/O를 명확히 분리하여 관리 가능합니다. |
| **결국은 어플리케이션 서비스로 로직이 밀려나게 됨**  | 도메인 이벤트만으로 처리할 수 없으니, 외부 연동은 어플리케이션 서비스에서 처리하게 되는데, 이 경우 도메인 이벤트와 어플리케이션 서비스가 **단단히 결합**되는 경향이 생깁니다. 즉, 이벤트 흐름이 깔끔하지 않고 얽히게 됩니다.        |


### **그렇다면 어플리케이션 레이어에서만 이벤트를 정의하면 되지 않아?**

그 또한 아래와 같은 문제를 발생시킬 수 있습니다.

| 구분                   | 도메인 이벤트 부재 시 어플리케이션 이벤트만 사용했을 때 문제점      |
| -------------------- | ---------------------------------------- |
| **이벤트 발행 즉시성**       | 도메인 상태 변화 즉시 이벤트 발행 어려움                  |
| **도메인-이벤트 일관성**      | 도메인 모델과 이벤트 흐름이 분리되어 데이터 일관성 유지 어려움      |
| **비즈니스 규칙 표현력 저하**   | 도메인 모델 내 비즈니스 규칙과 이벤트 발행 연계 약화           |
| **복잡한 흐름 추적 어려움**    | 복잡한 도메인 상태 변경을 어플리케이션 이벤트만으로 추적 및 관리 어려움 |
| **트랜잭션 경계 내 통합 어려움** | 상태 변경과 이벤트 발행의 트랜잭션 통합 제어가 힘들어짐          |
| **테스트 및 유지보수 비용 증가** | 도메인 모델과 이벤트 발행이 분리되어 단위 테스트와 유지보수 시 불편함  |



## 결론
### **그럼 어떻게 하자고?**

저는 도메인 이벤트와 어플리케이션 이벤트를 동시에 사용하는 방식을 제안합니다.

### **그렇다면 어떻게 두 이벤트를 동시에 활용할건데?**

도메인 이벤트는 **도메인 모델 내부의 상태 변화나 비즈니스 규칙의 결과를 외부에 알리는 데 집중하며**, <br>어플리케이션 이벤트는 **유스케이스 단위의 실행 흐름을 외부 시스템이나 다른 바운디드 컨텍스트로 확산시키는 데 목적**이 있습니다. <br>이 둘을 함께 사용하는 전략은 다음과 같습니다:

1. 도메인 모델 내부에서 도메인 이벤트를 발행
    * Aggregate root 내부에서 상태 변경이 발생했을 때 DomainEvent를 발행합니다.
    * 이 이벤트는 순수한 비즈니스 규칙의 결과이며, 외부 인프라에 대한 의존이 전혀 없어야 합니다.
    * 예시: OrderPlaced, InventoryDecreased, PaymentConfirmed 등

2. 어플리케이션 레이어에서 도메인 이벤트를 수신 → 어플리케이션 이벤트로 변환
    * 도메인 이벤트 리스너(Application Service 내부 또는 별도 subscriber)가 해당 이벤트를 수신
    * 트랜잭션 안에서만 처리 가능한 작업은 여기서 수행 (예: 로깅, 내부 알림 등)
    * 외부 시스템과의 연동이 필요하거나 비동기 처리가 필요한 경우, 도메인 이벤트를 어플리케이션 이벤트로 변환하여 비동기 발행

3. 어플리케이션 이벤트는 interface 레이어(외부 연동, 메시징, Saga 트리거) 등에서 활용
    * 어플리케이션 이벤트는 외부 메시지 브로커(Kafka, RabbitMQ 등)에 전송하거나, 다른 바운디드 컨텍스트와 통신할 때 사용
    * 이 레벨에서 기술적 실패 대응, 재시도, 로깅 등의 로직을 함께 구현할 수 있음

<요약하자면>

| 구분               | 도메인 이벤트                  | 어플리케이션 이벤트                            |
| ---------------- | ------------------------ | ------------------------------------- |
| 발행 위치            | 도메인 모델 내부 (엔티티, 애그리거트 등) | 어플리케이션 서비스 or 도메인 이벤트 리스너에서 변환 발행     |
| 목적               | 비즈니스 상태 변화 알림            | 외부 시스템과의 연동, 바운디드 컨텍스트 간 통신, 비동기 확장 등 |
| 처리 시점            | 트랜잭션 내부                  | 트랜잭션 이후 또는 별도 비동기 큐 처리                |
| 외부 시스템 의존성 포함 여부 | 없음 (순수 로직)               | 있음 (Kafka, Email, Notification 등)     |

## 부록

### 어플리케이션 레이어 사용 시 주의할 점 

아래는 어플리케이션 레이어를 도입하면서 생기는 이슈를 방지하기 위해 제가 세운 규칙입니다.

1. 비즈니스 로직은 도메인 모델에 둡니다
    * 어플리케이션 레이어는 여러 도메인 기능을 조합하고 흐름을 제어하는 역할만 맡습니다.
    * 핵심 비즈니스 규칙은 도메인(Entity, Domain Service)에 두고, 어플리케이션 서비스는 이를 호출하거나 조합하는 데 집중합니다.
    * 그래야 도메인이 건강한 상태로 유지되고, 모든 로직이 한곳에 몰려 ‘빈껍데기 도메인’이 되는 것을 막을 수 있습니다.

2. 도메인과 어플리케이션 서비스의 역할과 이름을 명확히 구분합니다
    * 비슷한 이름이나 기능이 중복되면 팀 내 혼란이 커집니다.
    * 도메인 서비스는 ‘비즈니스 규칙과 처리’를 담당하고, 어플리케이션 서비스는 ‘프로세스 흐름과 순서’에 집중하는 구조를 유지해야 합니다.
    * 팀 내에서 각 레이어의 책임과 명명 규칙에 대해 합의하는 것이 중요합니다.

3. 어플리케이션 레이어는 경계를 지켜야 합니다
    * 같은 바운디드 컨텍스트 내부 도메인과, 명확히 의존성이 설정된 외부 도메인만 접근할 수 있어야 합니다.
    * 무분별하게 다른 컨텍스트 내부 모델에 접근하면 의존성이 꼬이고 유지보수가 어려워집니다.
    * 반드시 컨텍스트 간 인터페이스(포트)를 통해서만 교류해야 합니다.

4. 분산 락과 트랜잭션 범위는 어플리케이션에서 관리합니다
    * 분산 락이나 트랜잭션의 범위는 도메인과 책임이 겹치지 않도록 어플리케이션 레이어에서 담당합니다.
    * 단, 데이터베이스 락(DB 락)은 도메인 내부에서 활용할 수 있습니다.

## 추후 더 고려해볼 내용
개선 및 보완 제안
1. 도메인 이벤트와 어플리케이션 이벤트의 중첩/중복 문제에 대한 구체적 해결책 부족

    문서에서는 "도메인 이벤트 → 어플리케이션 이벤트 변환"의 흐름을 제안하지만, 변환 과정에서 이벤트가 중복 발생하거나 흐름이 복잡해질 가능성에 대한 대책이 부족합니다.

    예를 들어, 동일 비즈니스 상태 변화에 대해 도메인 이벤트가 여러 개 발생하고, 이를 어플리케이션 이벤트로 어떻게 깔끔히 묶거나 분리할지, 이벤트 중복 방지 전략(예: 이벤트 ID, deduplication) 등을 명확히 하면 좋겠습니다.

2. 트랜잭션 경계 및 데이터 일관성 문제의 기술적 상세
    "트랜잭션 내 도메인 이벤트 발행"과 "트랜잭션 외 어플리케이션 이벤트 발행" 간에 Exactly-once 메시징 보장 문제를 언급했는데, 이를 어떻게 기술적으로 보장할지 방법론(예: Outbox 패턴, Transactional Messaging) 정도라도 언급해주면 설계 신뢰도가 올라갑니다.

    실제 구현에서 이런 부분이 가장 난해한데, 문서가 좀 더 현실적 가이드라인을 주면 좋겠어요.

3. 이벤트 핸들링 실패 시 재시도 및 장애 대응
    어플리케이션 이벤트는 외부 연동과 비동기 처리의 책임이 있다면서 장애 대응(재시도, DLQ 등)을 언급했지만, 구체적인 패턴이나 책임 경계가 좀 더 필요합니다.

    예를 들어, 이벤트 처리 실패 시 어플리케이션 서비스가 어느 선까지 책임지고, 도메인은 완전 무관한지, 실패 알림이나 롤백 시나리오 등도 고려하는 게 현실적입니다.

4. 어플리케이션 이벤트의 소비자 설계 언급 부족
    어플리케이션 이벤트가 여러 외부 시스템이나 다른 바운디드 컨텍스트로 전파된다고 했는데, 이벤트 소비자(리스너)의 구조, 구독 관리, 이벤트 버전 관리에 대한 언급이 없습니다.

    장기 유지보수에 중요한 내용이라, 간단히라도 다뤄주면 좋겠습니다.

5. 도메인 이벤트의 구조와 내용 표준화 필요성
    도메인 이벤트는 순수 비즈니스 상태 변화임을 강조하지만, 이벤트 페이로드, 불변성, 버전 관리 등 도메인 이벤트 설계 관련 구체 가이드라인이 없습니다.

    이 부분이 부실하면 이벤트가 점점 복잡해지고 도메인 모델과 이벤트 간 불일치가 발생할 수 있습니다.

6. 어플리케이션 레이어를 통한 이벤트 흐름 제어의 단점 부재
    어플리케이션 레이어를 통한 이벤트 흐름 제어가 장점이긴 하지만, 반대로 어플리케이션 레이어가 너무 커지고 비대해질 위험, 이벤트 간 의존성 증가로 인한 유지보수 비용 상승 등 단점도 일부 언급해주면 균형 잡힌 시각이 됩니다.